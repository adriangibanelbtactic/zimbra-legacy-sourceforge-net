
# __STORE

store: CUR_DEST_ROOT := $(STORE_DEST_ROOT)
store: CUR_PACKAGE_SPEC := $(BUILD_ROOT)/zimbra.spec
store: CUR_PACKAGE_NAME := zimbra-store
store: $(PACKAGE_DIR) store_stage store_pkg_spec_$(PACKAGE_EXT)
	(cd $(CUR_DEST_ROOT); \
		$(PACKAGING_COMMAND) $(PACKAGING_OPTIONS) )

store_pkg_spec_pkg: $(BUILD_ROOT)/resources/zimbra-store $(BUILD_ROOT)/zimbra-store.Info.plist $(BUILD_ROOT)/zimbra-store.Description.plist $(STORE_DEST_DIR)/$(TOMCAT_DIR)/compat

$(STORE_DEST_DIR)/$(TOMCAT_DIR)/compat: force
	(cd $(STORE_DEST_DIR)/$(TOMCAT_DIR); tar xzf \
	$(THIRD_PARTY)/jakarta-tomcat/apache-tomcat-5.5.12-compat.tar.gz; \
	mv apache-tomcat-5.5.12/bin/* bin/; \
	mv apache-tomcat-5.5.12/common/endorsed/* common/endorsed; \
	rm -rf apache-tomcat-5.5.12;)

$(BUILD_ROOT)/zimbra-store.Description.plist:
	cat $(PACKAGE_CONF_DIR)/Spec/zimbra-store.Description.plist | \
	sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
	-e 's/@@RELEASE@@/$(RELEASE)/' \
	-e 's/@@MAJOR@@/$(MAJOR)/' \
	-e 's/@@MINOR@@/$(MINOR)/' > $@

$(BUILD_ROOT)/zimbra-store.Info.plist:
	cat $(PACKAGE_CONF_DIR)/Spec/zimbra-store.Info.plist | \
	sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
	-e 's/@@RELEASE@@/$(RELEASE)/' \
	-e 's/@@MAJOR@@/$(MAJOR)/' \
	-e 's/@@MINOR@@/$(MINOR)/' > $@

$(BUILD_ROOT)/resources/zimbra-store:
	mkdir -p $@
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra-store.postinstall $@/postinstall
	chmod 755 $@/postinstall
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra-store.postinstall $@/postupgrade
	chmod 755 $@/postupgrade
#       cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbrastore.pre $@/preinstall
#       echo "#!/bin/bash" > $@/postinst
#       echo "sh /opt/zimbra/bin/zmfixperms.sh" >> $@/postinst
#       cat $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbrastore.post >> $@/postinstall
#       chmod 555 $@/*

store_pkg_spec_deb: $(STORE_DEST_ROOT)/DEBIAN/control

$(STORE_DEST_ROOT)/DEBIAN: force
	mkdir -p $@
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.pre $@/preinst
	echo "#!/bin/bash" > $@/postinst
	echo "sh /opt/zimbra/bin/zmfixperms.sh" >> $@/postinst
	cat $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.post >> $@/postinst
	chmod 555 $@/*

$(STORE_DEST_ROOT)/DEBIAN/control: $(STORE_DEST_ROOT)/DEBIAN force
	cat $(PACKAGE_CONF_DIR)/Spec/zimbrastore.deb | \
	sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
	-e 's/@@RELEASE@@/$(RELEASE)/' \
	-e 's/@@ARCH@@/$(ARCH)/' > $@

store_pkg_spec_rpm: $(BUILD_ROOT)/zimbra.spec

$(BUILD_ROOT)/zimbra.spec:
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.pre $(BUILD_ROOT)
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.post $(BUILD_ROOT)
	cat $(PACKAGE_CONF_DIR)/Spec/zimbra.spec | \
		sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
		-e 's/@@RELEASE@@/$(RELEASE)/' \
		-e 's/^Copyright:/$(RPMCOPYRIGHTSTR):/' \
		-e '/^%pre$$/ r zimbra.pre' \
		-e '/^%post$$/ r zimbra.post' > $(BUILD_ROOT)/zimbra.spec
	rm -f zimbra.pre
	rm -f zimbra.post
	echo "%attr(-, zimbra, zimbra) /opt/zimbra/jakarta-tomcat-5.5.7" >> \
		$(BUILD_ROOT)/zimbra.spec
	echo "%attr(-, zimbra, zimbra) /opt/zimbra/mysql-standard-4.1.10a-pc-linux-gnu-i686" >> \
		$(BUILD_ROOT)/zimbra.spec

store_stage: $(STORE_COMPONENTS)

$(STORE_DEST_DIR):
	mkdir -p $@

$(STORE_DEST_DIR)/$(MYSQL_DIR):
	@echo "*** Creating mysql"
	(cd $(STORE_DEST_DIR); tar xzf $(MYSQL_SOURCE).tar.gz;)
	(cd $(STORE_DEST_DIR)/$(MYSQL_DIR)/lib; tar xzf $(THIRD_PARTY)/mysql/$(BUILD_PLATFORM)/mysql-$(MYSQL_CLIENT_VERSION).tgz)


$(STORE_DEST_DIR)/$(TOMCAT_DIR)/bin: $(STORE_DEST_DIR) force
	@echo "*** Creating tomcat"
	(cd $(STORE_DEST_DIR); tar xzf $(TOMCAT_SOURCE).tar.gz;)

$(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf: force
	mkdir -p $@
	cp -f $(SERVICE_DIR)/conf/tomcat-5.5/server.xml.production \
		$(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf/server.xml
	cp -f $(SERVICE_DIR)/conf/zimbra.xml \
		$(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf/Catalina/localhost/zimbra.xml
	mkdir -p $(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf/AdminService/localhost
	cp -f $(SERVICE_DIR)/conf/zimbraAdmin.xml \
		$(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf/AdminService/localhost/zimbraAdmin.xml
	cp -f $(SERVICE_DIR)/conf/tomcat-5.5/tomcat-users.xml $(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf
	cp -f $(SERVICE_DIR)/build/dist/conf/log4j.properties.production  \
		$(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf/log4j.properties

$(STORE_DEST_DIR)/$(TOMCAT_DIR)/temp: force
	mkdir -p $(STORE_DEST_DIR)/$(TOMCAT_DIR)/temp
	touch $(STORE_DEST_DIR)/$(TOMCAT_DIR)/temp/.emptyfile

$(STORE_DEST_DIR)/$(TOMCAT_DIR): $(STORE_DEST_DIR) $(STORE_DEST_DIR)/$(TOMCAT_DIR)/bin $(STORE_DEST_DIR)/$(TOMCAT_DIR)/conf $(STORE_DEST_DIR)/$(TOMCAT_DIR)/temp $(STORE_DEST_DIR)/$(TOMCAT_DIR)/common/lib

$(WEBAPP_DIR): 
	mkdir -p $@
